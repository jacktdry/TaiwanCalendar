name: å°ç£è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è‡ªå‹•æ›´æ–°

# è§¸ç™¼æ¢ä»¶
on:
  push:
  # æ¯æœˆ1è™Ÿ UTC 00:00 åŸ·è¡Œ (å°ç£æ™‚é–“ä¸Šåˆ8é»)
  schedule:
    - cron: "0 0 1 * *"
  # æ”¯æ´æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¨­å®šæœ€å°æ¬Šé™åŸå‰‡ - åƒ…æˆäºˆå¿…è¦æ¬Šé™
permissions:
  contents: write    # åƒ…æˆäºˆå…§å®¹å¯«å…¥æ¬Šé™ï¼Œç”¨æ–¼æäº¤å’Œæ¨é€æª”æ¡ˆ
  actions: read      # åƒ…æˆäºˆ actions è®€å–æ¬Šé™

jobs:
  update-calendar:
    name: æ›´æ–°å°ç£è¾¦å…¬æ—¥æ›†è³‡æ–™
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Job å±¤ç´šæ¬Šé™è¨­å®š
    permissions:
      contents: write      # éœ€è¦å¯«å…¥æª”æ¡ˆå…§å®¹
      actions: read        # éœ€è¦è®€å– actions

    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è¨­å®šPythonç’°å¢ƒ
      - name: è¨­å®šPython 3.13ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      # 3. å®‰è£ç›¸ä¾å¥—ä»¶
      - name: å®‰è£ç›¸ä¾å¥—ä»¶
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. è¨­å®šGitä½¿ç”¨è€…è³‡è¨Š
      - name: è¨­å®šGitä½¿ç”¨è€…è³‡è¨Š
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # 5. åŸ·è¡Œçˆ¬èŸ²ç¨‹å¼
      - name: åŸ·è¡Œå°ç£è¾¦å…¬æ—¥æ›†çˆ¬èŸ²
        run: |
          echo "é–‹å§‹åŸ·è¡Œå°ç£è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†çˆ¬èŸ²ç³»çµ±..."
          python main.py
        env:
          PYTHONUNBUFFERED: 1
          FORCE_UPDATE: 'false'

      # 6. æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´
      - name: æª¢æŸ¥æª”æ¡ˆè®Šæ›´
        id: check_changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²’æœ‰æª”æ¡ˆéœ€è¦æ›´æ–°"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ç™¼ç¾æª”æ¡ˆè®Šæ›´ï¼Œæº–å‚™æäº¤"
            git status --porcelain
          fi

      # 7. æäº¤è®Šæ›´
      - name: æäº¤è®Šæ›´åˆ°Git
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # å–å¾—ç•¶å‰æ—¥æœŸæ™‚é–“
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          TAIWAN_DATE=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')

          # çµ±è¨ˆæª”æ¡ˆæ•¸é‡
          CSV_COUNT=$(find origin -name "*.csv" 2>/dev/null | wc -l || echo "0")
          JSON_COUNT=$(find docs -name "*.json" 2>/dev/null | wc -l || echo "0")

          # æäº¤è®Šæ›´
          git commit -m "ğŸ—“ï¸ è‡ªå‹•æ›´æ–°å°ç£è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è³‡æ–™

          ğŸ“Š æ›´æ–°çµ±è¨ˆ:
          - CSVæª”æ¡ˆ: ${CSV_COUNT} å€‹
          - JSONæª”æ¡ˆ: ${JSON_COUNT} å€‹

          â° æ›´æ–°æ™‚é–“:
          - UTC: ${CURRENT_DATE}
          - å°ç£æ™‚é–“: ${TAIWAN_DATE}

          ğŸ¤– ç”± GitHub Actions è‡ªå‹•åŸ·è¡Œ"

          echo "è®Šæ›´å·²æäº¤åˆ°æœ¬åœ°Git"

      # 8. æ¨é€è®Šæ›´åˆ°é ç«¯å€‰åº«
      - name: æ¨é€è®Šæ›´åˆ°GitHub
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
          force: false

      # 9. åŸ·è¡Œçµæœé€šçŸ¥
      - name: åŸ·è¡Œçµæœæ‘˜è¦
        if: always()
        run: |
          echo "=================================="
          echo "å°ç£è¾¦å…¬æ—¥æ›†è‡ªå‹•æ›´æ–°åŸ·è¡Œå®Œæˆ"
          echo "=================================="

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… ç‹€æ…‹: æˆåŠŸæ›´æ–°ä¸¦æ¨é€æª”æ¡ˆ"
            CSV_COUNT=$(find origin -name "*.csv" 2>/dev/null | wc -l || echo "0")
            JSON_COUNT=$(find docs -name "*.json" 2>/dev/null | wc -l || echo "0")
            echo "ğŸ“Š æª”æ¡ˆçµ±è¨ˆ: ${CSV_COUNT} å€‹CSV, ${JSON_COUNT} å€‹JSON"
          else
            echo "â„¹ï¸  ç‹€æ…‹: æ²’æœ‰æª”æ¡ˆéœ€è¦æ›´æ–°"
          fi

          echo "ğŸ•’ åŸ·è¡Œæ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S') UTC"
          echo "ğŸŒ å°ç£æ™‚é–“: $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')"
          echo "=================================="

      # 10. ä¸Šå‚³åŸ·è¡Œç´€éŒ„ï¼ˆç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼‰
      - name: ä¸Šå‚³åŸ·è¡Œç´€éŒ„
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: |
            origin/
            docs/
          retention-days: 7
